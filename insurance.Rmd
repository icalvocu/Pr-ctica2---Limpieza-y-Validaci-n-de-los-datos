---
title: "Práctica 2 - Limpieza y validación de los datos"
author: "Irene Calvo Cuesta - icalvocu"

output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_libraries, include=FALSE}
library(knitr)
library(stringr)
library(psych)
library(VIM)

```

##**1. Descripción del dataset. ¿Por qué es importante y qué pregunta/problema pretende responder?**

El dataset elegido recoge un análisis sobre los gastos médicos individuales facturados por el seguro de salud de Estados Unidos, y una serie de características personales de los asegurados. Para realizar el análisis se han recogido datos de 1338 asegurados.
El objetivo de dicho análisis es investigar si se puede predecir la prima del seguro a partir de la edad del asegurado, su género, su índice de masa corporal, el número de hijos que tiene y por tanto que están cubiertos por el seguro de salud, si es fumador o no, y la región de Estados Unidos en la que vive; y que grado de influencia tienen dichas características sobre los costos del seguro. 

##**2. Integración y selección de los datos de interés a analizar.**

En primer lugar se debe realizar la carga de los datos, para ello se inspecciona el tipo de formato csv. Se puede comprobar que se usa la coma (,) como separador de valores y el punto (.) como separador decimal, por tanto se usará la funcion **read.csv()** para la lectura del fichero.

```{r chunk2.a}
#Lectura de datos
asegurados <- read.csv('insurance.csv')
#Se agiliza la manipulacion de los datos, para que no sea necesario especificar el nombre del dataframe
attach(asegurados)

#Se comprueba la carga correcta del archivo
str(asegurados)
#Se observan las primeras filas del conjunto
head(asegurados)
```
Como he comentado, el fichero que tenemos recoge información sobre una previsión del coste de la prima de los seguros médicos en Estados Unidos y una serie de datos personales de los asegurados. 

Podemos observar que el fichero contiene 7 variables que corresponden a la edad de los asegurados (**age**), al género (**sex**), al índice de masa corporal (**bmi**), el número de hijos (**children**), si fuman o no (**smoker**), la región a la que pertenecen (**region**), y los cargos de la prima del seguro (**charges**). Este fichero cuenta con 1338 observaciones. 

Visualizando las 5 primeras filas del archivo se comprueba que se ha cargado correctamente.

Por otro lado voy a observar las principales características que tiene las variables del conjunto de datos:
```{r chunk2.b}
#Se observan las principales características de las variables del conjunto
summary(asegurados)
```

Observamos que la muestra presenta una media de edad de 39 años, un índice de masa corporal medio de 30.66 kg/m2, una media de hijos entre 1 y 2, y unas primas de seguro medias de 13270$. 

Comprobamos también que los niveles de las variables categóricas son los correctos, que no es necesario realizar alguna estandarización en los nombre. La variable **sex** tiene dos niveles (female y male), la variables **smoker** tiene dos niveles (no y yes) en función de si el asegurado fuma o no, y la variable región tiene cuatro niveles correspondientes a la división por regiones de EEUU en noreste, noroeste, sureste, suroeste.

Si que voy a estandarizar los valores de la variable **bmi** en dos cifras decimales, y los de la variable **charges** en tres cifras decimales:
```{r chunk2.d}
#Estandarizacion variable bmi
asegurados$bmi<- round(asegurados$bmi, 2)
#Estandarizacion variable charges
asegurados$charges<- round(asegurados$charges, 3)

#Se comprueba que se ha realizado el cambio
head(asegurados, 3)
```

A continuación se va a comprobar si se cumple el tipo de variable estadística que debe tener asociada cada variable:

Las variables **sex**, **smoker**, y **region** deben ser de tipo factor (cualitativa nominal), ya que no tienen un criterio de orden; las variables **age** y **children** deben ser de tipo integer, ya que contienen valores discretos; y las variables **bmi** y **charges** deben ser de tipo numeric, ya que la naturaleza de estas variables es continua.

```{r chunk2.c}
#Se muestran los tipos de variables
sapply(asegurados, class)
```
Se observa que todas las variables tienen asignado el tipo apropiado, y por lo tanto no necesitan una conversión para conseguir que el tipo final sea el adecuado.


##**3. Limpieza de los datos.**
A continuación se va a llevar a cabo la limpieza de los datos. Este paso es muy importante en cualquier análisis de datos.

###**3.1 ¿Los datos contienen ceros o elementos vacíos? ¿Cómo gestionarías cada uno de estos casos?**

En primer lugar se va a buscar si los datos co
```{r chunk8a}
#Se busca que variable tiene elementos vacios
sapply(asegurados, function(x) sum(is.na(x)))
```
Se observa que ninguna de las variables contiene elementos vacíos, por tanto no habría que seguir ningún procedimiento adicional.

En el caso de que si que hubiese registros desconocidos una decisión sería eliminar dichos registros, siempre y cuando fuese una cantidad que no afectase a nuestra investigación; otro de los procedimientos, que sería el que yo utilizaría para gestionarlo, sería imputar los valores faltantes a partir de los k-vecinos más cercanos, utilizando por ejemplo la distancia de Gower.


###**3.2 Identificación y tratamiento de valores extremos**

Para identificar los valores extremos voy a presentar un boxplot para cada variable cuantitativa. En este dataset las variables cuantitativas que tenemos son: **age**, **children**, **bmi**, y **charges**.

```{r chunk3.2}
par(mfrow = c(1,2))
boxplot(asegurados$age, main='Age', col = 'grey')
boxplot(asegurados$children, main='Childrens', col = 'grey')
boxplot(asegurados$bmi, main='BMI', col = 'grey')
boxplot(asegurados$charges, main='Charges', col = 'grey')

```

Se encuentran varios valores atípicos en las variables **bmi** y **charges**. Por tanto voy a inspeccionar dichos valores 

```{r chunk7b}
#lista de valores atípicos
boxplot.stats(asegurados$bmi)$out
boxplot.stats(asegurados$charges)$out

length(boxplot.stats(asegurados$bmi)$out)
length(boxplot.stats(asegurados$charges)$out)

```

Se observa que hay 9 valores extremos en la variable **bmi**, y 139 valores extremos de la variable **charges**, de un total de 1338 observaciones, por lo que se va a considerar que no son valores erroneos sino que al ser escogidos aleatoriamente se han podido dar en distinto asegurados. 

Una vez realizada la limpieza de los datos se va a proceder a su análisis.


##**4. Análisis de los datos.**

###**4.1. Selección de los grupos de datos que se quieren analizar/comparar (planificación de los análisis a aplicar).**

Voy a realizar una agrupacion por condicion de fumador, que me será util a la hora de analizar los datos.
```{r chunk4.1}
asegurados.fumadores <- asegurados[asegurados$smoker=='yes',]
asegurados.nofumadores <- asegurados[asegurados$smoker=='no',]

```


###**4.2. Comprobación de la normalidad y homogeneidad de la varianza.**

Para comprobar la normalidad de la varianza voy a applicar el **test de Shapiro Wilk** en las variables cuantitativas (**age**, **children**, **bmi**, y **charges**)

```{r chunk4.2.a}
asegurados.cuantit <- asegurados[, c(1,3,4,7)]

alpha = 0.05
for(i in 1:length(asegurados.cuantit)){
  if(shapiro.test(asegurados.cuantit[,i])$p.value<alpha){
    cat('Se rechaza la hipótesis nula. La variable', names(asegurados.cuantit)[i], 'no sigue una distribución normal.\n')
  }
  else{
    cat('No se rechaza la hipótesis nula. La variable', names(asegurados.cuantit)[i], 'sigue una distribución normal.\n')
  }
}
```


```{r chunk4.2.b}

```


###**4.3. Aplicación de pruebas estadísticas para comparar los grupos de datos. En función de los datos y el objetivo del estudio, aplicar pruebas de contraste de hipótesis, correlaciones, regresiones, etc.**

Voy a contrastar el hecho de que el valor medio de las primas del seguro de los no fumadores sea inferior al valor medio de las primas del seguro de los fumadores.
```{r chunk4.3.a}
t.test(asegurados.nofumadores$charges, asegurados.fumadores$charges, mu=0, conf.level = 0.95, alternative = 'less')
```


```{r chunk4.3.b}

```


```{r chunk4.3.c}

```


##**5. Representación de los resultados a partir de tablas y gráficas.**


Antes de finalizar se va a crear el archivo de datos corregido, con todos los cambios hasta el momento: 

```{r chunk10}
write.csv(asegurados, file = 'insurance_clean.csv', row.names = FALSE)
```

##**6. Resolución del problema. A partir de los resultados obtenidos, ¿cuáles son las conclusiones? ¿Los resultados permiten responder al problema?**

Después de la limpieza, análisis, y representación de los datos se puede concluir


##**7. Código: Hay que adjuntar el código, preferiblemente en R, con el que se ha realizado la limpieza, análisis y representación de los datos. Si lo preferís, también podéis trabajar en Python.**

El código se encuentra en el archivo 'insurance.Rmd'
